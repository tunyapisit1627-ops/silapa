@model IEnumerable<contacts>
@{
    ViewData["Title"] = "ข้อมูลจัดการภาพติดบัตร";
    int i = 1;
}

<div class="card">
    <div class="card-header">
        <h3 class="card-title">จัดการข้อมูลผู้ประสานงาน </h3>
        <div class="card-tools">
            <span class="badge badge-danger">@DateTime.Now</span>
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-minus"></i>
            </button>
            <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <ul id="contactList" class="users-list clearfix sortable-list">
            @foreach (var dr in Model)
            {
                <li data-id="@dr.id">
                    <img width="128" height="128" src="@dr.ImageUrl" alt="User Image"
                        onclick="openCropModal('@dr.id', '@dr.ImageUrl')">
                    <a class="users-list-name" href="#">@dr.name</a>
                    <span class="users-list-date"><a href="#"
                            onclick="openEditModal('@dr.id','@dr.title','@dr.name','@dr.position','@dr.Location','@dr.tel','@dr.ImageUrl')">แก้ไข</a>
                        | <a href="#" class="text-danger" onclick="openDeleteModal('@dr.id', '@dr.name')">ลบ</a>
                    </span>
                </li>
            }
        </ul>
        </div>
    <div class="card-footer text-center">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addContactModal">
            เพิ่มข้อมูล
        </button>
    </div>
    </div>

<div class="modal fade" id="addContactModal" tabindex="-1" role="dialog" aria-labelledby="addContactModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addContactModalLabel">เพิ่มข้อมูลใหม่</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addContactForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="form-group">
                        <label for="title">ส่วนหัว</label>
                        <input id="pid" name="pid" hidden>
                        <input id="imgurl" name="imgurl" hidden>
                        <input type="text" class="form-control" id="title" name="title" placeholder="กรอกส่วนหัว">
                    </div>
                    <div class="form-group">
                        <label for="name">ชื่อ</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="กรอกชื่อ">
                    </div>
                    <div class="form-group">
                        <label for="position">ตำแหน่ง</label>
                        <input type="text" class="form-control" id="position" name="position" placeholder="กรอกตำแหน่ง">
                    </div>
                    <div class="form-group">
                        <label for="location">สถานที่</label>
                        <input type="text" class="form-control" id="location" name="location" placeholder="กรอกสถานที่">
                    </div>
                    <div class="form-group">
                        <label for="tel">เบอร์โทร</label>
                        <input type="text" class="form-control" id="tel" name="tel" placeholder="กรอกเบอร์โทร">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="imageCropModal" tabindex="-1" aria-labelledby="imageCropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageCropModalLabel">Edit Image</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="imageInput">Choose an image</label>
                    <input type="file" id="imageInput" class="form-control" accept="image/*" onchange="loadImage(event)">
                </div>
                <div class="img-container mt-3">
                    <img id="imageToCrop" src="" alt="Image for cropping" style="max-width: 100%; display: none;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="cropImage()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">ยืนยันการลบข้อมูล</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลของ <strong id="contactNameToDelete"></strong>?
                <br>การกระทำนี้ไม่สามารถย้อนกลับได้
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">ยืนยันการลบ</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
    // ======================================================================
    // ## ส่วนที่ 1: โค้ดเดิมของคุณที่ทำงานได้ดีอยู่แล้ว ##
    // (ตัวแปรและฟังก์ชันที่เรียกจาก onclick)
    // ======================================================================
    var cropper;
    var selectedHId = null;
    var contactIdToDelete = null;

    function loadImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const imageElement = document.getElementById('imageToCrop');
                imageElement.src = e.target.result;
                imageElement.style.display = 'block';
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageElement, { aspectRatio: 1, viewMode: 1 });
            };
            reader.readAsDataURL(file);
        }
    }

    function cropImage() {
        if (!cropper || typeof cropper.getCroppedCanvas() === 'undefined') {
            alert('กรุณาเลือกไฟล์ภาพเพื่อ Crop');
            return;
        }
        const croppedDataUrl = cropper.getCroppedCanvas({ width: 512, height: 512 }).toDataURL('image/jpeg');
        $.ajax({
            url: '/Admin/UpdateImage',
            type: 'POST',
            data: { croppedImage: croppedDataUrl, id: selectedHId },
            success: function (response) {
                if (response.success) {
                    const updatedImageUrl = `${response.newImageUrl}?v=${new Date().getTime()}`;
                    $(`li[data-id="${selectedHId}"] img`).attr('src', updatedImageUrl);
                    $('#imageCropModal').modal('hide');
                    alert("อัปเดตรูปภาพสำเร็จ!");
                } else {
                    alert(response.message || "เกิดข้อผิดพลาด");
                }
            },
            error: function () { alert("เกิดข้อผิดพลาดในการเชื่อมต่อ"); }
        });
    }

    function openCropModal(id, imageUrl) {
        selectedHId = id;
        $('#imageInput').val(null);
        if (cropper) {
            cropper.destroy();
        }
        const imageElement = document.getElementById('imageToCrop');
        imageElement.style.display = 'none';
        imageElement.src = imageUrl;
        $('#imageCropModal').modal('show');
    }

    function openEditModal(id, title, name, position, location, tel, imgurl) {
        $('#addContactModal .modal-title').text('แก้ไขข้อมูล');
        $('#pid').val(id);
        $('#title').val(title);
        $('#name').val(name);
        $('#position').val(position);
        $('#location').val(location);
        $('#tel').val(tel);
        $('#imgurl').val(imgurl);
        $('#addContactModal').modal('show');
    }

    function openDeleteModal(id, name) {
        contactIdToDelete = id;
        $('#contactNameToDelete').text(name);
        $('#deleteConfirmModal').modal('show');
    }

    // ======================================================================
    // ## ส่วนที่ 2: โค้ดที่ต้องรอให้หน้าเว็บโหลดเสร็จก่อน (ส่วนที่แก้ไข) ##
    // ======================================================================
    $(function () {
        
        const contactList = document.getElementById('contactList');
        if (contactList) {
            new Sortable(contactList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const orderedIds = Array.from(contactList.querySelectorAll('li')).map(item => item.getAttribute('data-id'));
                    var token = $('input[name="__RequestVerificationToken"]').val();
                    fetch('/Admin/UpdateOrder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                        body: JSON.stringify(orderedIds)
                    });
                }
            });
        }

        $('button[data-target="#addContactModal"]').on('click', function() {
            var modal = $('#addContactModal');
            modal.find('.modal-title').text('เพิ่มข้อมูลใหม่');
            modal.find('form')[0].reset();
            modal.find('#pid').val('0');
            modal.find('#imgurl').val('/images/default-user.png');
        });

        $("#addContactForm button.btn-primary").on("click", function () {
            const contactData = { id: $("#pid").val(), title: $("#title").val().trim(), name: $("#name").val().trim(), position: $("#position").val().trim(), location: $("#location").val().trim(), tel: $("#tel").val().trim(), imageUrl: $("#imgurl").val() };
            if (!contactData.title || !contactData.name) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
            var token = $('input[name="__RequestVerificationToken"]').val();
            fetch("/Admin/saveContactModal", { method: "POST", headers: { "Content-Type": "application/json", 'RequestVerificationToken': token }, body: JSON.stringify(contactData) })
                .then(res => res.json()).then(data => { if (data.success) { alert("บันทึกข้อมูลสำเร็จ"); window.location.reload(); } else { throw new Error(data.message); } })
                .catch(err => { console.error(err); alert("เกิดข้อผิดพลาด"); });
        });

        $('#confirmDeleteButton').on('click', function () {
            if (contactIdToDelete) {
                var token = $('input[name="__RequestVerificationToken"]').val();
                $.ajax({
                    url: '/Admin/DeleteContact',
                    type: 'POST',
                    data: { id: contactIdToDelete, __RequestVerificationToken: token },
                    success: function (res) {
                        if (res.success) {
                            alert(res.message);
                            $(`li[data-id="${contactIdToDelete}"]`).fadeOut(400, function () { $(this).remove(); });
                        } else { alert(res.message); }
                    },
                    error: function () { alert('เกิดข้อผิดพลาด'); },
                    complete: function () { $('#deleteConfirmModal').modal('hide'); }
                });
            }
        });
        
        $('#imageCropModal').on('shown.bs.modal', function () {
            const imageElement = document.getElementById('imageToCrop');
            if (imageElement.src && imageElement.src !== window.location.href) {
                imageElement.style.display = 'block';
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageElement, { aspectRatio: 1, viewMode: 1 });
            }
        });
    });
</script>

<style>
    .sortable-ghost {
        opacity: 0.4;
        background-color: #f0f8ff;
    }

    .sortable-list li {
        cursor: move;
    }
</style>