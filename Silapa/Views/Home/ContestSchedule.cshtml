@using System.Web
@using System.Text.Encodings.Web
@using System.Globalization
@model IEnumerable<Competitionlist>
@{
    var datasetting = ViewBag.setupsystem;
    var teamCounts = ViewBag.TeamCounts as Dictionary<int, int> ?? new Dictionary<int, int>();
    // ----------------------------------------------------
    // ‚¨áÔ∏è 1. (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏£‡∏±‡∏ö ViewBag ‡πÄ‡∏õ‡πá‡∏ô List<racedetails>
    // ----------------------------------------------------
    var allRaceDetails = ViewBag.competitionData as List<racedetails>;
    // ----------------------------------------------------
    
    // (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ allRaceDetails ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß)

    List<string> categories = new List<string>();
    if (allRaceDetails != null)
    {
        // 2. (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏î‡∏∂‡∏á Category ‡∏à‡∏≤‡∏Å racedetails.Competitionlist
        categories = allRaceDetails
            .Select(rd => rd.Competitionlist?.Category?.Name) 
            .Where(cat => !string.IsNullOrEmpty(cat))
            .Distinct()
            .ToList();
    }
    
    var raceDays = ViewBag.RaceDays as List<DateTime>;
    
    // (‡∏•‡∏ö var allRaceDetails = ... (‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô) ‡∏≠‡∏≠‡∏Å)

    int dayCount = 1;

    // 3. (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏¢‡πâ‡∏≤‡∏¢ 'aRaceDetails' ‡πÅ‡∏•‡∏∞ 'groupedByVenue' ‡∏°‡∏≤‡πÉ‡∏ä‡πâ allRaceDetails ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    var aRaceDetails = allRaceDetails?
        .Where(rd => rd.status == "1")
        .OrderBy(rd => rd.building) 
        .ThenBy(rd => rd.time) 
        .ToList();

    var groupedByVenue = aRaceDetails?
        .GroupBy(rd => new { rd.r_id, rd.building, rd.Racelocation?.name }) 
        .Select(g => new
        {
            VenueId = g.Key.r_id,
            VenueName = g.Key.name,
            Building = g.Key.building,
            Events = g.ToList()
        })
        .OrderBy(v => v.Building)
        .ToList();
        
    List<string> venueNames = new List<string>();
    if (groupedByVenue != null)
    {
        venueNames = groupedByVenue
            .Select(v => v.VenueName) 
            .Where(name => !string.IsNullOrEmpty(name))
            .Distinct()
            .ToList();
    }
}

<div class="containerkowaill">
    <!-- Page Header -->
    <div class="page-header">
        <h1>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>
        <p>@datasetting.name</p>
    </div>
    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-number">@ViewBag.datalist</div>
            <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üè´</div>
            <div class="stat-number">@ViewBag.School</div>
            <div class="stat-label">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üë®‚Äçüéì</div>
            <div class="stat-number">@ViewBag.datacounts</div>
            <div class="stat-label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìç</div>
            <div class="stat-number">@ViewBag.Racelocation</div>
            <div class="stat-label">‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
        </div>
    </div>
    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-tabs">
            <button class="active">üìö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            @foreach (var category in categories)
            {
                <button data-filter="@category">@category</button>
            }
        </div>

        <div class="schedule-search-filters">
            <div class="schedule-search-group">
                <span class="schedule-search-icon">üîç</span>
                <input type="text" id="scheduleSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...">
            </div>
            <div class="schedule-search-group">
                <span class="schedule-search-icon">üìç</span>
                <select id="venueFilter">
                    <option value="‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô - ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô - ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    @if (venueNames != null && venueNames.Any())
                    {
                        @foreach (var venueName in venueNames)
                        {
                            // üö® ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Venue Name) ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á value ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                            // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ rd.Racelocation?.name
                            <option value="@venueName">@venueName</option>
                        }
                    }
                </select>
            </div>
        </div>
    </div>
    <!-- Day Tabs -->
    <div class="day-tabs">
        @if (raceDays != null && raceDays.Any())
        {
            @foreach (var day in raceDays)
            {
                // üö® ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô racedetails.daterace
                var dayString = day.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture);

                // 2. üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:
                var eventCount = allRaceDetails?
    .Count(d =>
    {
        if (string.IsNullOrEmpty(d.daterace)) return false;

        var dateParts = d.daterace.Split(new string[] { " - " }, StringSplitOptions.RemoveEmptyEntries);
        if (dateParts.Length < 1) return false;

        // 2. üö® (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡πÅ‡∏õ‡∏•‡∏á "racedetail" (dd/MM/yyyy) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô DateTime
        var startDateStr = dateParts[0].Trim(); 
        if (DateTime.TryParseExact(startDateStr, "MM/dd/yyyy", CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime parsedStartDate))
        {
            // 3. üö® (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö "Date" ‡∏Å‡∏±‡∏ö "Date" (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÄ‡∏ß‡∏•‡∏≤)
            return parsedStartDate.Date == day.Date;
        }
        return false;
    });

                // ‡πÉ‡∏ä‡πâ CultureInfo "th-TH" ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                <div class="day-tab" data-date="@day.ToString("MM-dd-yyyy", System.Globalization.CultureInfo.InvariantCulture)">
                    <div class="day-number">@dayCount</div>
                    <div class="day-name">@day.ToString("dddd", new System.Globalization.CultureInfo("th-TH"))</div>
                    <div class="day-date">@day.ToString("d MMMM yyyy", new System.Globalization.CultureInfo("th-TH"))</div>
                    <div class="event-count">@(eventCount ?? 0) ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                dayCount++;
            }
        }
        else
        {
            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        }
    </div>
   <div class="schedule-container mt-4">

    @if (groupedByVenue == null || !groupedByVenue.Any())
    {
        <div class="alert alert-info text-center">
            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        </div>
    }
    else
    {
        @* ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ *@
        @foreach (var venue in groupedByVenue)
        {
            <div class="venue-section">
                <div class="venue-header">
                    <div class="venue-icon">üìç</div>
                    <div class="venue-info">
                        <h3>@venue.VenueName - @venue.Building</h3>
                        <p>@* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Model Racelocation *@</p>
                    </div>
                </div>
                
                <div class="events-timeline">
                
                    @* ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô *@
                    @foreach (var detail in venue.Events)
                    {
                        // üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å (Competitionlist)
                        var contest = detail.Competitionlist; 
                        var venueIdFilter = detail.r_id;
                            var categoryFilter = contest.Category?.Name;
                            var typeFilter = contest.type;

                            int teamCount = 0;
                            teamCounts.TryGetValue(contest.Id, out teamCount);
                          // dateFilterRaw ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ MM/dd/yyyy 
    var dateFilterRaw = detail.daterace?.Split(new string[] { " - " },
        StringSplitOptions.RemoveEmptyEntries).FirstOrDefault()?.Trim();
        
    // üö® 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Day Filter ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö MM-dd-yyyy 
    string dayFilterText = string.Empty;
    if (!string.IsNullOrEmpty(dateFilterRaw))
    {
        // MM/dd/yyyy -> MM-dd-yyyy
        dayFilterText = dateFilterRaw.Replace('/', '-');
    }

                            <div class="event-card" data-search-text="@(contest.Name) @(detail.building) @(detail.room) @dayFilterText"
                                data-date="@dateFilterRaw" data-category="@(contest.Category?.Name)" 
                                data-venue="@(venue.VenueName)">
                            <div class="event-header">
                                @* üö® detail.time ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô string (‡πÄ‡∏ä‡πà‡∏ô "08:00") ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô "08:00 - 10:00" *@
                                <div class="event-time">üïê @detail.time</div> 
                                <div class="event-badges">
                                    <span class="badge badge-category">@contest.Category?.Name</span> @* ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *@
                                    <span class="badge badge-level">@contest.type</span> @* ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *@
                                    @* üî¥ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° Badge LIVE ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô *@
                                </div>
                            </div>
                            
                            <div class="event-title">@contest.Name</div>
                            
                            <div class="event-details">
                                @* üö® ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ racedetails ‡∏°‡∏µ property ‡∏ä‡∏∑‡πà‡∏≠ teacher ‡∏´‡∏£‡∏∑‡∏≠ details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£/‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° *@
                                <div class="detail-item">
                                    <span class="detail-icon">üë®‚Äç‚öñÔ∏è</span>
                                    <span>‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£: (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£)</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üë•</span>
                                    <span>@contest.student ‡∏Ñ‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</span> @* ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏à‡∏≤‡∏Å Competitionlist.student *@
                                </div>
                                <div class="detail-item">
                                <span class="detail-icon">üèÜ</span>
                                 <span>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥): <b>@teamCount ‡∏ó‡∏µ‡∏°</b></span>
                                 </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üìç</span>
                                    <span>‡∏´‡πâ‡∏≠‡∏á @detail.room</span> @* ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å racedetails.room *@
                                </div>
                                <div class="detail-item">
                                    <span class="detail-icon">üóìÔ∏è</span>
                                    <span>‡∏ß‡∏±‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô: @FormatThaiDateRange(detail.daterace)</span> @* ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô *@
                                </div>
                            </div>
                            
                            <div class="event-actions">
                                <button class="btn btn-primary">üìä ‡∏î‡∏π‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏î</button>    
                                   @* 1. ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á (‡πÉ‡∏ä‡πâ data-toggle/data-target ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤) *@
                                   @if (User.IsInRole("Member")) 
                                   {
                                     <button class="btn btn-outline btn-registered-list" data-toggle="modal"
                                        data-target="#RegisteredListModal" data-competition-id="@contest.Id"
                                        data-contest-name="@contest.Name">
                                         üë• ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
                                    </button>
                                   }

                                    @* 2. ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÉ‡∏ä‡πâ data-toggle/data-target ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤) *@
                                    <button class="btn btn-outline btn-details" data-toggle="modal" data-target="#DetailsModal"
                                        data-contest-name="@contest.Name"
                                        data-details="@System.Text.Encodings.Web.HtmlEncoder.Default.Encode(detail.details)">
                                        üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                    </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
   </div>
</div>

@* Modal #DetailsModal *@
<div class="modal fade" id="DetailsModal" tabindex="-1" role="dialog" aria-labelledby="DetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="DetailsModalLabel">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô: <span id="contestTitle"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"> @* üö® ‡πÉ‡∏ä‡πâ data-dismiss="modal" *@
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="contestDetailsContent" style="padding: 10px;">
                    <div class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
</div>
@* Modal #RegisteredListModal *@
<div class="modal fade" id="RegisteredListModal" tabindex="-1" role="dialog" aria-labelledby="RegisteredListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="RegisteredListModalLabel">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô: <span id="listContestTitle"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"> @* üö® ‡πÉ‡∏ä‡πâ data-dismiss="modal" *@
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
           <div class="modal-body">
                <div id="registeredListData" class="p-3">
                    <div class="text-center p-5 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
</div>
@functions {
    private string FormatThaiDateRange(string dateRangeString)
    {
        if (string.IsNullOrEmpty(dateRangeString)) return "(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î)";

        try
        {
            // 1. ‡πÅ‡∏¢‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Start - End)
            var parts = dateRangeString.Split(new string[] { " - ", "-" }, StringSplitOptions.RemoveEmptyEntries);
            
            // ‚ö°Ô∏è (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Format ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° Database
            // (‡∏ñ‡πâ‡∏≤ DB ‡πÄ‡∏Å‡πá‡∏ö "12/10/2025" ‡πÄ‡∏õ‡πá‡∏ô "10 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤" -> ‡πÉ‡∏ä‡πâ "dd/MM/yyyy")
            // (‡∏ñ‡πâ‡∏≤ DB ‡πÄ‡∏Å‡πá‡∏ö "12/10/2025" ‡πÄ‡∏õ‡πá‡∏ô "12 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°" -> ‡πÉ‡∏ä‡πâ "MM/dd/yyyy")
            // ‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "dd/MM/yyyy" (‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)
            string[] formats = { "MM/dd/yyyy","dd/MM/yyyy" }; 
            var provider = System.Globalization.CultureInfo.InvariantCulture;

            DateTime startDate;
            DateTime endDate;

            // 2. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏•‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏ö‡∏ö)
            if (!DateTime.TryParseExact(parts[0].Trim(), formats, provider, System.Globalization.DateTimeStyles.None, out startDate))
            {
                 return dateRangeString; // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            }

            if (parts.Length > 1)
            {
                if (!DateTime.TryParseExact(parts[1].Trim(), formats, provider, System.Globalization.DateTimeStyles.None, out endDate))
                {
                    endDate = startDate;
                }
            }
            else
            {
                endDate = startDate;
            }

            // 3. ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÑ‡∏ó‡∏¢
            var thaiCulture = new System.Globalization.CultureInfo("th-TH");

            // (‡∏Å‡∏£‡∏ì‡∏µ 1) ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            if (startDate.Date == endDate.Date)
            {
                return startDate.ToString("d MMMM yyyy", thaiCulture);
            }
            // (‡∏Å‡∏£‡∏ì‡∏µ 2) ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            else if (startDate.Month == endDate.Month && startDate.Year == endDate.Year)
            {
                return $"{startDate.Day}-{endDate.Day} {endDate.ToString("MMMM yyyy", thaiCulture)}";
            }
            // (‡∏Å‡∏£‡∏ì‡∏µ 3) ‡∏Ñ‡∏ô‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
            else
            {
                return $"{startDate.ToString("d MMM yyyy", thaiCulture)} - {endDate.ToString("d MMM yyyy", thaiCulture)}";
            }
        }
        catch
        {
            return dateRangeString;
        }
    }
}
@section Scripts
{ 
    <script>
        $(document).ready(function () {
            
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î .select2, .DataTable, .school-link) ...
            
            // ----------------------------------------------------
            // 1. Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Summernote Details)
            // ----------------------------------------------------
            // Modal ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢ data-toggle/data-target
            // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ 'shown.bs.modal' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ Modal ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            $('#DetailsModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                var contestName = button.data('contest-name');
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà Encode ‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞ Decode ‡∏Å‡∏•‡∏±‡∏ö
                // üö® ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ data-attribute ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (data-details)
                var encodedDetails = button.data('details'); 
                
                // ‡πÉ‡∏ä‡πâ Textarea ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Decode HTML Entity
                var decodedDetails = $('<textarea/>').html(encodedDetails).text(); 

                var modal = $(this);
                modal.find('#contestTitle').text(contestName);
                
                // ‡πÅ‡∏ó‡∏£‡∏Å HTML ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å Summernote ‡∏•‡∏á‡πÉ‡∏ô Modal
                modal.find('#contestDetailsContent').html(decodedDetails);
            });

            // ----------------------------------------------------
            // 2. Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (AJAX Load)
            // ----------------------------------------------------
            $('#RegisteredListModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var competitionId = button.data('competition-id');
                var contestName = button.data('contest-name');
                var modal = $(this);
                var loadingHtml = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

                modal.find('#listContestTitle').text(contestName);
                modal.find('#registeredListData').html(loadingHtml); // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏Å‡πà‡∏≠‡∏ô

                // üö® AJAX CALL: ‡∏™‡πà‡∏á Competition ID ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Controller
                $.ajax({
                    url: '@Url.Action("GetRegisteredList", "Home")', 
                    type: 'GET',
                    data: { competitionId: competitionId },
                    success: function (data) {
                        modal.find('#registeredListData').html(data);
                       
                    },
                    error: function (xhr, status, error) {
                        modal.find('#registeredListData').html(
                            '<div class="alert alert-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + xhr.responseText + '</div>'
                        );
                    }
                });
            });
            // ----------------------------------------------------
            // 3. üö® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á AJAX ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
            // ----------------------------------------------------
            $('#RegisteredListModal').on("keyup", "#searchRegistered", function() {
                const searchText = $(this).val().toLowerCase();

                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô Modal
                $('.registered-table').each(function() {
    const $table = $(this);
    const $tbody = $table.find('.registered-tbody');
    const $schoolHeader = $table.prev('.school-header'); 
    
    let foundInSchool = false; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ñ‡∏£‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const schoolName = $schoolHeader.data('school-name') ? 
                        $schoolHeader.data('school-name').toLowerCase() : '';

    // üö® ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const matchSchoolNameOnly = schoolName.includes(searchText);

    if (matchSchoolNameOnly) {
        // 1.1 ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ foundInSchool ‡πÄ‡∏õ‡πá‡∏ô true
        $tbody.find('tr').show();
        foundInSchool = true;
        
    } else {
        // 1.2 ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ñ‡∏£‡∏π‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        $tbody.find('tr').each(function() {
            const $row = $(this);
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 2-3 ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)
            const rowText = $row.children('td:nth-child(3), td:nth-child(4)').text().toLowerCase();

            if (rowText.includes(searchText)) {
                $row.show();
                foundInSchool = true;
            } else {
                $row.hide();
            }
        });
    }

    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°)
    if (foundInSchool || matchSchoolNameOnly) { // üí° ‡πÉ‡∏ä‡πâ matchSchoolNameOnly ‡πÅ‡∏ó‡∏ô schoolName.includes(searchText)
         // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        $schoolHeader.show();
        $table.show(); 
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        $schoolHeader.hide();
        $table.hide();
    }
});
                
            });
       // ----------------------------------------------------
            // üö® Centralized Reset Function
            // ----------------------------------------------------
            function resetAllFilters() {
                // 1. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                $('#scheduleSearchInput').val('');
                
                // 2. ‡∏•‡∏ö Active Class ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Day Tabs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                $('.day-tabs .day-tab').removeClass('active');
                
                // 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Dropdown ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                $('#venueFilter').val('‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô - ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
                
                // 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Category Tab ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà 'üìö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
                $('.filter-tabs button').removeClass('active');
                $('.filter-tabs button:first').addClass('active');
                
                // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                $('.event-card').show();
                $('.venue-section').show(); 
            }


            // ----------------------------------------------------
            // 4. Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Client-Side Filtering (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á)
            // ----------------------------------------------------
            function applyFilters() 
            {
                // üö® HARD RESET: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reset ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                $('.event-card').show(); 
                
                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                const currentSearchText = $('#scheduleSearchInput').val().toLowerCase().trim().replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/\s\s+/g, ' '); 
                const activeCategory = $('.filter-tabs button.active').data('filter'); 
                const activeVenue = $('#venueFilter').val(); 
                
                // üö® ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Day Tab ‡πÉ‡∏î‡∏ñ‡∏π‡∏Å Active ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const $activeDayTab = $('.day-tabs .day-tab.active');
                const isDayTabActive = $activeDayTab.length > 0;
                
                // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô event-card ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÉ‡∏ö
                $('.event-card').each(function() {
                    const $card = $(this);
                    
                    const cardDateRaw = String($card.data('date')); // MM/dd/yyyy
                    const cardSearchText = (String($card.data('search-text')) || '').toLowerCase(); 
                    const cardCategory = String($card.data('category')); 
                    const cardVenue = String($card.data('venue')); 
                    
                    let isMatch = true; 

                    // A. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search Text)
                    if (currentSearchText) { 
                        if (!cardSearchText.includes(currentSearchText)) {
                             isMatch = false; 
                        }
                    }

                    // B. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Day Tab)
                    if (isMatch && isDayTabActive && !currentSearchText) { 
                        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Data-Attribute ‡∏Ç‡∏≠‡∏á Tab ‡∏ó‡∏µ‡πà Active ‡∏≠‡∏¢‡∏π‡πà
                        const requiredDate = $activeDayTab.data('date').replace(/-/g, '/');
                        
                        if (!cardDateRaw.includes(requiredDate)) { 
                            isMatch = false; 
                        }
                    }

                    // C. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Category Tabs)
                    if (isMatch && activeCategory && activeCategory !== 'üìö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
                        if (cardCategory !== activeCategory) {
                            isMatch = false;
                        }
                    }
                    
                    // D. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Venue Name Only)
                    if (isMatch && activeVenue && activeVenue !== '‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô - ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
                        if (activeVenue !== cardVenue) {
                             isMatch = false;
                        }
                    }
                    
                    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô
                    $card.toggle(isMatch); 
                });
                
                // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á Venue Section 
                $('.venue-section').each(function() {
                    const $venueSection = $(this);
                    const visibleEvents = $venueSection.find('.event-card:visible').length;
                    
                    $venueSection.toggle(visibleEvents > 0);
                });
            }

            // ----------------------------------------------------
            // 5. ‡∏ú‡∏π‡∏Å Event Listeners (‡πÉ‡∏ä‡πâ Self-Exclusion Logic)
            // ----------------------------------------------------

            // A. Search Input (Keyup)
            $('#scheduleSearchInput').on('keyup', function() {
                // üö® Hard Reset (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
                $('.day-tabs .day-tab').removeClass('active');
                $('#venueFilter').val('‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô - ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
                $('.filter-tabs button').removeClass('active');
                $('.filter-tabs button:first').addClass('active');
                
                applyFilters(); 
            });

            // B. Day Tabs (Click)
            $('.day-tabs .day-tab').on('click', function() {
                
                // üö® FULL RESET
                resetAllFilters(); 
                
                // 1. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Reset ‡πÑ‡∏õ
                $(this).addClass('active');
                
                applyFilters(); 
            });
            
            // C. Category Tabs (Click)
            $('.filter-tabs button').on('click', function() {
                
                // üö® ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Filter ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const selectedCategory = $(this).data('filter');
                
                // 2. FULL RESET
                resetAllFilters(); 
                
                // 3. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Reset ‡πÑ‡∏õ
                $('.filter-tabs button[data-filter="' + selectedCategory + '"]').addClass('active');
                
                applyFilters(); 
            });

            // D. Venue Filter (Change)
            $('#venueFilter').on('change', function() { 
                
                // üö® ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Filter ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const selectedVenue = $(this).val();
                
                // 2. FULL RESET
                resetAllFilters(); 
                
                // 3. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Reset ‡πÑ‡∏õ (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Dropdown)
                $('#venueFilter').val(selectedVenue);
                
                applyFilters(); 
            });
            
            // ----------------------------------------------------
            // 6. Initial Load
            // ----------------------------------------------------
            
            // 1. Active Category Tab ‡πÅ‡∏£‡∏Å ('üìö ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')
            $('.filter-tabs button:first').addClass('active'); 
            
            // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
            applyFilters(); 
            
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î change event ‡∏Ç‡∏≠‡∏á dropdown ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ...
            
        });
    </script>
    @* ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠) ... *@
}