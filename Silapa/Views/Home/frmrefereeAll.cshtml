@model IEnumerable<category>
@inject ApplicationDbContext _db_layout
@{
    var activeSystem = _db_layout.setupsystem.FirstOrDefault(s => s.status == "1");
    ViewData["Title"] = $"{activeSystem.name}";
    IList<referee> data = ViewBag.referee;
    IList<referee> data1 = ViewBag.referee31;
    IList<Competitionlist> datacom = ViewBag.com;
    IList<groupreferee> datagroupreferee = ViewBag.groupreferee;
    int n = 1;
    int id = 31;
    int gg_id = 25;

}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">ค้นหาข้อมูล</h3>
        <form id="searchForm">
            <div class="input-group input-group-sm">
                @Html.DropDownList("m_id", ViewBag.categoryData as SelectList,
                         "เลือกหมวดหมู่/สาระ", new
                         {
                             @class = "form-control select2",
                             id = "searchDropdown",
                             onchange = "handleDropdownChange(this)"
                         })
            </div>
        </form>

    </div>
</div>
<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">คณะกรรมการอำนวยการ</h3>

            <div class="card-tools">
                <span class="badge badge-danger">@DateTime.Now</span>
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-minus"></i>
                </button>
                <button type="button" class="btn btn-tool" data-card-widget="remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <!-- /.card-header -->
        <div class="card-body p-0">
            <ul class="users-list clearfix">
                @foreach (var drr in data1)
                {
                    <li>
                        <img width="100" height="100" src="@drr.ImageUrl" alt="User Image">
                        <a class="users-list-name" href="#">@drr.name</a>
                        <span class="users-list-date">@drr.role</span>
                    </li>
                }
            </ul>
            <!-- /.users-list -->
        </div>
        <!-- /.card-body -->
        <div class="card-footer text-center">
            <a class="btn btn-primary btn-sm" asp-action="GeneratePdf" asp-controller="Pdf" asp-route-id="31"
                asp-route-g_id="50" asp-route-type="rr">
                <i class="fas fa-folder">
                </i>
                ปริ้นบัตรทั้งหมด
            </a>
        </div>
        <!-- /.card-footer -->
    </div>
</div>
@foreach (var dr in Model)
{

    var datac = datacom.Where(x => x.c_id == dr.Id && x.status == "1").ToList();
    var datagroup = datagroupreferee.Where(x => x.c_id == dr.Id).ToList();
    if (dr.Id != 1 && dr.Id != 2 && dr.Id != 5 && dr.Id != 6 && dr.Id != 7)
    {
        foreach (var item in datagroup)
        {
            // id=item.c_id
            var datar = data.Where(x => x.m_id == dr.Id && x.c_id == 0 && x.g_id == item.id).ToList();
            <div class="col-md-12">
    <!-- USERS LIST -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">@item.name @dr.Name</h3>

            <div class="card-tools">
                <span class="badge badge-danger">@DateTime.Now</span>
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-minus"></i>
                </button>
                <button type="button" class="btn btn-tool" data-card-widget="remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <!-- /.card-header -->
        <div class="card-body p-0">
            <ul class="users-list clearfix">
                @foreach (var drr in datar)
                            {
                                id = drr.m_id;
                                gg_id = (int)drr.g_id;
                                <li>
                                    <img width="100" height="100" src="@drr.ImageUrl" alt="User Image">
                                    <a class="users-list-name" href="#">@drr.name</a>
                                    <span class="users-list-date">@drr.role</span>
                                    <a class="btn btn-primary btn-sm" asp-action="GeneratePdf" asp-controller="Pdf" asp-route-id="@id"
                                        asp-route-g_id="@gg_id" asp-route-type="rr" asp-route-r_id="@drr.id">
                                        <i class="fas fa-folder">
                                        </i>
                                        ปริ้นบัตร
                                    </a>
                                </li>
                            }
                        </ul>
                        <!-- /.users-list -->
                    </div>
                    <!-- /.card-body -->
                    <div class="card-footer text-center">
                        <a class="btn btn-primary btn-sm" asp-action="GeneratePdf" asp-controller="Pdf" asp-route-id="@id"
                            asp-route-g_id="@gg_id" asp-route-type="rr">
                            <i class="fas fa-folder">
                            </i>
                            ปริ้นบัตรทั้งหมด
                        </a>
                    </div>
                    <!-- /.card-footer -->
                </div>
                <!--/.card -->
            </div>
        }

    }
    @foreach (var dc in datac)
    {
        var datarc = data.Where(x => x.m_id == dc.c_id && x.c_id == dc.Id).ToList();
        <div class="col-md-12">
    <!-- USERS LIST -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">คณะกรรมการ @dc.Name</h3>

            <div class="card-tools">
                <span class="badge badge-danger">@DateTime.Now</span>
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-minus"></i>
                </button>
                <button type="button" class="btn btn-tool" data-card-widget="remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <!-- /.card-header -->
        <div class="card-body p-0">
            <ul class="users-list clearfix">
                @foreach (var drr in datarc)
                        {
                            id = (int)drr.c_id;
                            gg_id = (int)drr.g_id;
                            <li>
                                <img width="100" height="100" src="@drr.ImageUrl" alt="User Image">
                                <a class="users-list-name" href="#">@drr.name</a>
                                <span class="users-list-date">@drr.role</span>
                                <a class="btn btn-primary btn-sm" asp-action="GeneratePdf" asp-controller="Pdf" asp-route-id="@id"
                                    asp-route-g_id="@gg_id" asp-route-type="r" asp-route-r_id="@drr.id">
                                    <i class="fas fa-folder">
                                    </i>
                                    ปริ้นบัตร
                                </a>
                            </li>
                        }
                    </ul>
                    <!-- /.users-list -->
                </div>
                <!-- /.card-body -->
                <div class="card-footer text-center">
                    <a class="btn btn-primary btn-sm" asp-action="GeneratePdf" asp-controller="Pdf" asp-route-id="@id"
                        asp-route-g_id="@gg_id" asp-route-type="r">
                        <i class="fas fa-folder">
                        </i>
                        ปริ้นบัตรทั้งหมด
                    </a>
                </div>
                <!-- /.card-footer -->
            </div>
            <!--/.card -->
        </div>
    }
}

@section Scripts {
    <script>
        $(function () {
            // 1. เปิด Select2
            $('.select2').select2();

            // 2. เปิด DataTable (ทุกตารางที่ใช้ ID "example1")
            // (หมายเหตุ: ID "example1" ไม่ควรซ้ำกัน, แต่ใน Template นี้พอทำงานได้)
            $("#example1").DataTable({
                "responsive": true, "lengthChange": false, "autoWidth": false, 
                "ordering": true, "pageLength": 20, "orderMulti": true,
                "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
            }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
            
            $('#example2').DataTable({
                "paging": true, "lengthChange": false, "searching": false,
                "ordering": true, "info": true, "autoWidth": false, "responsive": true,
            });
        });

        // 3. ฟังก์ชัน Dropdown
        function handleDropdownChange(selectElement) {
            const selectedOption = selectElement.value;

            if (!selectedOption) {
                // (ไม่จำเป็นต้อง Alert, แค่โหลดหน้า "ทั้งหมด")
                window.location.href = '@Url.Action("frmrefereeAll", "Home")';
                return;
            }
            
            window.location.href = `@Url.Action("frmrefereeAll", "Home")?m_id=${selectedOption}`;
        }
    </script>
}