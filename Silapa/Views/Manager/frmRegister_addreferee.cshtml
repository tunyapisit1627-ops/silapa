@model Competitionlist
@{
    ViewData["Title"] = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£";
    var c_name = ViewBag.c_name;
    IList<referee> referees = ViewBag.referees;
    var s = 1;
    var t = 1;
}
@Html.AntiForgeryToken()

<body class="hold-transition sidebar-mini">

    <div class="card card-info">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="card-header">
            <h2 class="card-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</h2>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card-header">
                            <h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                            <input asp-for="Id" id="c_Id" name="c_Id" hidden>

                        </div>
                        <div class="card-body">
                            <div class="form-group row">
                                <label for="inputEmail3" class="col-sm-2 col-form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                                <div class="col-sm-10">
                                    <input hidden id="c_id" value="@ViewBag.c_id">
                                    <input hidden id="m_id" value="@ViewBag.m_id">
                                    <input hidden id="SettingID" value="@ViewBag.SettingID">
                                    <input value="@c_name" id="c_name" readonly class="form-control" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="inputEmail3" class="col-sm-2 col-form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <div class="col-sm-10">
                                    <input value="@ViewBag.type" id="type" readonly class="form-control" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="inputEmail3" class="col-sm-2 col-form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</label>
                                <div class="col-sm-10">
                                    <input value="@ViewBag.d" id="d" readonly class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</h3>
                            </div>
                            <div class="row">

                                <div class="col-4">
                                    <input type="text" class="form-control" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
                                </div>
                                <div class="col-2">
                                    <select class="form-control select2" id="role">
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
                                        <option value="‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô">‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô</option>
                                        <option value="‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô">‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô</option>
                                        <option value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</option>
                                        <option value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <input type="text" class="form-control" id="position"
                                        placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                                </div>
                                <div class="col-2">
                                    <button type="button" class="btn btn-block bg-gradient-primary"
                                        id="addRow">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                    <button type="button" class="btn btn-block bg-gradient-success" id="saveEdit"
                                        style="display:none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <table id="teacherTable" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                            <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                            <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        @if (referees != null)
                                        {
                                            int no = 1;
                                            foreach (var dr in referees)
                                            {
                                                <tr>
                                                    <td>@no</td>
                                                    <td>@dr.name</td>
                                                    <td>@dr.role</td>
                                                    <td>@dr.position</td>
                                                    <td>
                                                        <input type="hidden" name="Id" value="@dr.id" /> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå Id -->
                                                        <input type="hidden" name="ImageUrl" value="@dr.ImageUrl" />
                                                        <input type="hidden" name="u_id" value="@dr.u_id" />
                                                        <input type="hidden" name="status" value="@dr.status" />
                                                        <input type="hidden" name="m_id" value="@dr.m_id" />
                                                        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå Id -->
                                                        <button class="btn btn-warning btn-sm"
                                                            onclick="editTeacherRowData(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                                        <button class="btn btn-danger btn-sm" data-id="@dr.id"
                                                            onclick="deleteTeacherRow(this)">‡∏•‡∏ö</button>
                                                    </td>
                                                </tr>
                                                no += 1;
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="card-footer">
                <button type="submit" id="saveData" value="Submit" class="btn btn-info">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button asp-action="frmList" asp-controller="Admin" class="btn btn-default float-right">Cancel</button>
            </div>
        </section>

    </div>
</body>
<script src="~/plugins/jquery/jquery.min.js"></script>
<script>
    $(function () {
        $('.select2').select2()
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let rowCount = document.querySelectorAll("#teacherTable tbody tr").length;

        document.getElementById("addRow").addEventListener("click", function () {
            const maxRows = parseInt(document.getElementById("d").value); // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å ViewBag.d
            const name = document.getElementById("name").value;
            const role = document.getElementById("role").value;
            const position = document.getElementById("position").value;

            if (name && role && position) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                if (rowCount >= maxRows) {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏¥‡∏ô ${maxRows} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
                    return;
                }

                rowCount++;

                const tableBody = document.getElementById("tableBody");
                const newRow = document.createElement("tr");
                newRow.innerHTML = `
        <td>${rowCount}</td>
        <td>${name}</td>
        <td>${role}</td>
        <td>${position}</td>
        <td>
            <button class="btn btn-warning btn-sm" onclick="editTeacherRowData(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger btn-sm" onclick="deleteTeacherRow(this)">‡∏•‡∏ö</button>
        </td>
            `;
                tableBody.appendChild(newRow);

                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï
                document.getElementById("name").value = "";
                document.getElementById("role").value = "";
                document.getElementById("position").value = "";
            } else {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            }
        });
    });

    function deleteTeacherRow(button) {
        if (confirm("Are you sure you want to delete this referee?")) {
            const refereeId = button.getAttribute('data-id'); // ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á referee
            $.ajax({
                url: '/Manager/Deleteferee', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Controller ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                type: 'POST',
                data: { id: refereeId },
                success: function (response) {
                    if (response.success) {
                        // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å DOM
                        $(button).closest('tr').remove();
                        alert("Referee deleted successfully.");
                    } else {
                        alert("Failed to delete referee.");
                    }
                },
                error: function () {
                    alert("An error occurred while deleting referee.");
                }
            });
        }
    }

    function editTeacherRowData(button) {
        const row = button.closest("tr");
        const name = row.cells[1].innerText;
        const role = row.cells[2].innerText;
        const position = row.cells[3].innerText;

        document.getElementById("name").value = name;
        document.getElementById("role").value = role;
        document.getElementById("position").value = position;

        document.getElementById("saveEdit").style.display = "block";
        document.getElementById("addRow").style.display = "none";

        document.getElementById("saveEdit").onclick = function () {
            row.cells[1].innerText = document.getElementById("name").value;
            row.cells[2].innerText = document.getElementById("role").value;
            row.cells[3].innerText = document.getElementById("position").value;

            document.getElementById("name").value = "";
            document.getElementById("role").value = "";
            document.getElementById("position").value = "";

            document.getElementById("saveEdit").style.display = "none";
            document.getElementById("addRow").style.display = "block";
        };
    }

    function updateRowNumbers() {
        const rows = document.querySelectorAll("#teacherTable tbody tr");
        rows.forEach((row, index) => {
            row.cells[0].innerText = index + 1;
        });
    }
    document.getElementById("saveData").addEventListener("click", function () {
        const c_id = document.getElementById("c_id").value; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å ViewBag.c_id
        const m_id = document.getElementById("m_id").value; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å ViewBag.c_id
        const SettingID = document.getElementById("SettingID").value; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å ViewBag.SettingID
        const rows = document.querySelectorAll("#teacherTable tbody tr");
        const teachers = Array.from(rows).map(row => {
            const id = row.querySelector("input[name='Id']") ? row.querySelector("input[name='Id']").value : 0;
            const imageUrlInput = row.querySelector("input[name='ImageUrl']");
            const imageUrl = imageUrlInput ? imageUrlInput.value : null;

            return {
                id: parseInt(id), // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ id ‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ 0 ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà)
                name: row.cells[1].innerText, // ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠
                role: row.cells[2].innerText, // ‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
                position: row.cells[3].innerText, // ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                imageUrl: imageUrl,
                u_id: "user123", // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á u_id
                m_id: parseInt(m_id), // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á m_id
                g_id: 0,
                status: "1",
                SettingID: parseInt(SettingID),
                c_id: parseInt(c_id), // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á c_id
                lastupdate: new Date().toISOString() // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            };
        });
        const token = $('input[name="__RequestVerificationToken"]').val();

        fetch("/Manager/Savereferees", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "RequestVerificationToken": token
            },
            body: JSON.stringify(teachers)
        })
            .then(async response => { // üí° ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô async function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠ response.text()
                if (!response.ok) {
                    // üö® ‡∏ñ‡πâ‡∏≤ Status Code ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 2xx (‡πÄ‡∏ä‡πà‡∏ô 400, 403, 500)
                    const errorText = await response.text(); // üåü ‡∏≠‡πà‡∏≤‡∏ô Response Body ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    console.error("HTTP Error Status:", response.status, "Response Body:", errorText);

                    // ‡πÇ‡∏¢‡∏ô Error ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ catch block ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                    throw new Error(`Server responded with status ${response.status}. Details: ${errorText.substring(0, 150)}...`);
                }
                // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Status 200) ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡πà‡∏≤‡∏ô Response ‡πÄ‡∏õ‡πá‡∏ô JSON
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    setTimeout(function () {
                        window.location.href = data.redirectUrl;
                    }, 2000);
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + data.message);
                }
            })
            .catch(error => {
                console.error("Final Error:", error);
                // üì¢ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + error.message);
            });
    });
</script>