@model IEnumerable<registerdirector>
@{
    ViewData["Title"] = "ข้อมูลการสมัครกรรมการ";
    int i = 1;
    // IList<Registerhead> models=ViewBag.data;
}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ข้อมูลการสมัครกรรมการ</h2>
    </div>
    <div>
        <form asp-controller="Manager" asp-action="frmapprovedirector">
            @Html.AntiForgeryToken()
            <div class="card-body">
                <!-- Main content -->
                <section class="content">
                    <div class="container-fluid">
                        <!-- SELECT2 EXAMPLE -->
                        <div class="card card-default">
                            <div class="card-header">
                                <h3 class="card-title">เงื่อนไขการค้นหา</h3>

                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <div class="form-group row">
                                    <label for="inputEmail3" class="col-sm-2 col-form-label">หมวดหมู่</label>
                                    <div class="col-sm-10">
                                        @Html.DropDownList("c_id", ViewBag.categoryData as SelectList,
                                        "เลือกหมวดหมู่/สาระ", new
                                        {
                                            @class = "form-control select2",
                                            id = "c_id",
                                            @name = "c_id"
                                        })
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.container-fluid -->
                </section>
                <!-- /.content -->
                <!-- /.card-body -->
                <div class="card-footer">
                    <button type="submit" class="btn btn-info">ค้นหา</button>
                    <button type="submit" class="btn btn-default float-right">Cancel</button>
                </div>
                <!-- /.card-footer -->
            </div>
        </form>
    </div>
    <div class="card-body">
        <table id="example1" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>
                        #
                    </th>
                    <th>
                        รูป
                    </th>
                    <th>
                        ชื่อ-สกุล
                    </th>
                    <th>
                        รายการ
                    </th>
                    <th>
                        โรงเรียน
                    </th>
                    <th>เบอร์โทร</th>
                    <th>
                        รายละเอียด
                    </th>
                    <th>
                        สถานะ
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {

                    <tr data-widget="expandable-table" aria-expanded="false">
                        <td align="center">
                            @i
                        </td>
                        <td align="center">
                            <img width="128" height="128"
                                src="@(!string.IsNullOrEmpty(item.ProfileImageUrl) ? item.ProfileImageUrl : "default-image.png")"
                                alt="User Image" />
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.name)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Competitionlist.Name)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.position)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.tel)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.experience)
                        </td>

                        <td align="center" id="status-@item.id">
                            @if(item.status == "1")
        {
            <span class="badge bg-warning">รอการอนุมัติ</span>
        }
        else if(item.status == "2")
        {
            <span class="badge bg-success">อนุมัติแล้ว</span>
        }
        else
        {
            <span class="badge bg-secondary">@item.status</span>
        }
                        </td>
                        <td align="center">
                            @if(item.status == "1") 
        {
            <button class="btn btn-success" onclick="approveUser(@item.id)">อนุมัติ</button>
        }
                        </td>
                    </tr>
                    i += 1;

                }
            </tbody>
        </table>
    </div>
</div>
<script src="~/plugins/jquery/jquery.min.js"></script>
<script>$(function () {
        $('.select2').select2()
        $("#example1").DataTable({
            "responsive": true, "lengthChange": false, "autoWidth": false, "ordering": true, "pageLength": 20, "orderMulti": true,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
        }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
        $('#example2').DataTable({
            "paging": true,
            "lengthChange": false,
            "searching": false,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
        });
    });</script>
<script>
    function approveUser(userId) {
        var token = $('input[name="__RequestVerificationToken"]').val();
        $.ajax({
            url: '@Url.Action("Approvedirector", "Manager")',
            type: 'POST',
            data: {
                __RequestVerificationToken: token,
                id: userId
            },
            success: function (response) {
                if (response.success) {
                    var statusCell = $('#status-' + userId);
                    statusCell.html('<span class="badge bg-success">อนุมัติแล้ว</span>');
                    
                    // (ซ่อนปุ่ม "อนุมัติ" ที่เราเพิ่งกดไป)
                    statusCell.next('td').find('button.btn-success').remove();
                    Swal.fire(
                        'อนุมัติสำเร็จ!',
                        'กรรมการถูกเพิ่มเข้าระบบแล้ว',
                        'success'
                    );
                } else {
                    Swal.fire(
                        'อนุมัติไม่สำเร็จ',
                        response.message, // (แสดง Error ที่ส่งมาจาก Controller)
                        'error'
                    );
                }
            },
            error: function () {
                Swal.fire('การเชื่อมต่อล้มเหลว', 'ไม่สามารถอนุมัติได้', 'error');
            }
        });
    }
</script>