@model IEnumerable<news>
@{
    ViewData["Title"] = "ข้อมูลข่าวประชาสัมพันธ์";
    int i = 1;
    // IList<RegisterViewModel> models=ViewBag.data;
}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ข้อมูลข่าวประชาสัมพันธ์</h2>
    </div>
    <div class="card-body">
        <table id="example1" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>
                        #
                    </th>
                    <th>
                        หัวข้อข่าว
                    </th>
                    <th>
                        วันที่ลง
                    </th>
                    <th>สถานะ</th>
                    <th>
                        <a asp-action="frmnewsadd" asp-controller="News" class="btn btn-outline-success"><i
                                class="fa fa-plus-square"></i>Create New</a>
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @i
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.titlename)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.lastupdate)
                        </td>
                        <td>
                            @if (User.IsInRole("Admin")) // ตรวจสอบว่า User มี Role "Admin" หรือไม่
                            {
                                <form asp-action="ToggleStatus" asp-controller="News" asp-route-id="@item.id" method="post"
                                    class="toggle-status-form">
                                    @if (item.status == "1")
                                    {
                                        <button type="submit" class="btn btn-sm btn-success">เผยแพร่</button>
                                    }
                                    else
                                    {
                                        <button type="submit" class="btn btn-sm btn-warning">ฉบับร่าง</button>
                                    }
                                </form>
                                <form asp-action="TogglePin" asp-route-id="@item.id" method="post" style="display: inline;"
                                    class="ml-1">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-link p-0" style="vertical-align: middle;"
                                        title="@(item.IsPinned ? "ยกเลิกปักหมุด" : "ปักหมุด")">

                                        @* 2. สลับไอคอนตามสถานะ *@
                                        @if (item.IsPinned)
                                        {
                                            <i class="fas fa-thumbtack fa-lg" style="color: #007bff;"></i> @* ไอคอนหมุด (สีเข้ม) *@
                                        }
                                        else
                                        {
                                            <i class="fas fa-thumbtack fa-lg text-muted"></i> @* ไอคอนหมุด (สีจาง) *@
                                        }
                                    </button>
                                </form>
                            }
                            else // ถ้าไม่ใช่ Admin ให้แสดงสถานะเป็นข้อความธรรมดา
                            {
                                @if (item.status == "1")
                                {
                                    <span class="badge bg-success">เผยแพร่</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning">ฉบับร่าง</span>
                                }
                            }
                        </td>

                        @if (ViewBag.UserId == item.u_id)
                        {
                            <td>
                                <a asp-action="frmnewsadd" asp-route-id="@item.id"><i class="fa fa-edit fa-lg"></i></a> |
                                <form asp-action="frmnewsdel" asp-route-id="@item.id" method="post" class="form-delete"
                                    style="display: inline;">

                                    <button type="submit" class="btn-delete text-danger ml-1"
                                        style="background: none; border: none; padding: 0; cursor: pointer;">
                                        <i class="fa fa-trash fa-lg"></i>
                                    </button>
                                </form>
                            </td>

                        }
                        else
                        {
                            <td></td>
                        }


                    </tr>
                    i += 1;
                }
            </tbody>
        </table>
    </div>
</div>
<link type="text/css" href="~/css/css/ui-lightness/jquery-ui-1.8.10.custom.css" rel="stylesheet" />
<script type="text/javascript" src="~/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="~/js/jquery-ui-1.8.10.offset.datepicker.min.js"></script>
<script src="~/plugins/jquery/jquery.min.js"></script>
<script>
    $(function () {
        // --- ส่วน DataTable (ของเดิม) ---
        $('.select2').select2()
        $("#example1").DataTable({
            "responsive": true, "lengthChange": false, "autoWidth": false, "ordering": true, "pageLength": 20, "orderMulti": true,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
        }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

        $('#example2').DataTable({
            "paging": true,
            "lengthChange": false,
            "searching": false,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
        });

        // ==========================================================
        // ## โค้ด AJAX ที่แก้ไขแล้วโดยใช้ Event Delegation ##
        // ==========================================================
        $('#example1 tbody').on('submit', '.toggle-status-form', function (e) {
            // 1. ป้องกันไม่ให้หน้าโหลดใหม่
            e.preventDefault();

            var form = $(this);
            var url = form.attr('action');
            var button = form.find('button');

            // 2. ส่งข้อมูลไปที่ Controller ด้วย AJAX
            $.ajax({
                type: 'POST',
                url: url,
                success: function (response) {
                    // 3. เมื่อ Server ตอบกลับมาว่าสำเร็จ
                    if (response.success) {
                        // **สำคัญ:** Controller คืนค่า status เป็น string ("0" หรือ "1")
                        // ดังนั้นต้องเปรียบเทียบกับ string
                        if (response.newStatus === "1") {
                            button.text('เผยแพร่');
                            button.removeClass('btn-warning').addClass('btn-success');
                        } else {
                            button.text('ฉบับร่าง');
                            button.removeClass('btn-success').addClass('btn-warning');
                        }
                    } else {
                        alert(response.message || 'เกิดข้อผิดพลาด');
                    }
                },
                error: function () {
                    alert('ไม่สามารถติดต่อเซิร์ฟเวอร์ได้');
                }
            });
        });
        // ตรวจสอบว่ามี TempData["Message"] ส่งมาหรือไม่
        @if (TempData["Message"] != null)
            {
                // ถ้ามี ให้ยิง SweetAlert
                // เราใช้ <text> เพื่อบอก Razor ว่านี่คือ JavaScript นะ
                <text>
                    Swal.fire({
                        icon: 'success',
                    title: 'สำเร็จ!',
                    text: '@Html.Raw(TempData["Message"])' // ใช้ Html.Raw กัน Error
                            });
                </text>
        }

    });
    // เมื่อ DOM โหลดเสร็จ
    document.addEventListener('DOMContentLoaded', function () {

        // เลือกฟอร์มลบทั้งหมด
        const deleteForms = document.querySelectorAll('.form-delete');

        deleteForms.forEach(form => {
            form.addEventListener('submit', function (event) {

                // *** 1. หยุดการ submit ฟอร์มตามปกติก่อน ***
                event.preventDefault();

                // (Optional) ดึงชื่อหรือ ID มาแสดงในข้อความ
                // const newsId = this.querySelector('.btn-delete').getAttribute('data-id');

                // *** 2. แสดง SweetAlert ***
                Swal.fire({
                    title: 'คุณแน่ใจหรือไม่?',
                    text: "คุณต้องการลบข้อมูลนี้ใช่ไหม (จะไม่สามารถกู้คืนได้)",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'ใช่, ลบเลย!',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    // *** 3. ถ้าผู้ใช้กดยืนยัน (OK) ***
                    if (result.isConfirmed) {
                        // ให้ submit ฟอร์มนี้ (ส่ง POST request ไปยัง frmnewsdel)
                        event.target.submit();
                    }
                });
            });
        });
    });
</script>